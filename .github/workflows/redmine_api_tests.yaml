# ------------------------------------------------------------------------------------------------------ #
# Redmine API Tests
# ------------------------------------------------------------------------------------------------------ #

name: 'Redmine API Tests'

# TODO: This should NOT run as often as everything else... perhaps a schedule?
on:
    push

env:
    # Location where Redmine instance must be installed
    REDMINE_INSTALL_PATH: '${{ github.workspace }}/redmine'

    # The default user for a new Redmine installation
    # @see https://www.redmine.org/projects/redmine/wiki/RedmineInstall#Step-10-Logging-into-the-application
    REDMINE_USER: 'admin'
    REDMINE_PASSWORD: 'admin'

    # Host and port for Redmine instance
    REDMINE_HOST: 'localhost'
    REDMINE_PORT: 3000

jobs:
    redmine_api_tests:
        name: "Redmine ${{ matrix.redmine-versions }} API Tests (using PHP ${{ matrix.php-versions }})"
        runs-on: ${{ matrix.operating-system }}

        strategy:
            fail-fast: true
            matrix:

                # See OS and PHP version options on https://github.com/shivammathur/setup-php
                operating-system: [ 'ubuntu-22.04' ]
                php-versions: [ '8.2' ]

                # Redmine versions (in this case branches)
                redmine-versions: [ '5.0-stable' ]

        steps:

            #            # ------------------------------------------------------------------------------------------------------- #
            #            # Checkout code ...
            #            # ------------------------------------------------------------------------------------------------------- #
            #
            #            -   name: "Checkout"
            #                uses: actions/checkout@v4
            #
            #            # ------------------------------------------------------------------------------------------------------- #
            #            # Setup & configure PHP
            #            # ------------------------------------------------------------------------------------------------------- #
            #
            #            -   name: "Setup PHP"
            #                uses: shivammathur/setup-php@v2
            #                with:
            #                    php-version: ${{ matrix.php-versions }}
            #
            #                    # PHP Extensions are based on those that Laravel also uses.args:
            #                    # @see https://github.com/laravel/framework/blob/11.x/.github/workflows/tests.yml
            #                    extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, gd, redis-phpredis/phpredis@5.3.7, igbinary, msgpack, lzf, zstd, lz4, memcached, gmp
            #                    ini-values: error_reporting=E_ALL
            #                    tools: composer:v2
            #                    coverage: none
            #
            #            -   name: "Install dependencies"
            #                run: composer install --no-progress --prefer-dist --no-interaction --optimize-autoloader --ansi

            # ------------------------------------------------------------------------------------------------------- #
            # Setup & configure Redmine
            # ------------------------------------------------------------------------------------------------------- #

            -   name: "Install Redmine"
                uses: hidakatsuya/action-setup-redmine@v2
                with:
                    repository: 'redmine/redmine'
                    version: ${{ matrix.redmine-versions }}
                    database: 'sqlite3'
                    ruby-version: '3.1'
                    path: "${{ env.REDMINE_INSTALL_PATH }}"

#            -   name: "Debug: output redmine config dir"
#                run: ls ${{ env.REDMINE_INSTALL_PATH }}/config

            -   name: "Enable REST Api"
                uses: rmeneely/update-yaml@v1
                with:
                    infile: ${{ env.REDMINE_INSTALL_PATH }}/config/settings.yml
                    varlist: 'rest_api_enabled.default=1'

#            -   name: "Debug: settings.xml"
#                run: cat ${{ env.REDMINE_INSTALL_PATH }}/config/settings.yml

            # TODO: ... create user

            # @see https://guides.rubyonrails.org/command_line.html#bin-rails-server
            -   name: "Start Redmine"
                run: |
                    cd ${{ env.REDMINE_INSTALL_PATH }}
                    nohup bundle exec rails server -e production -b ${{ env.REDMINE_HOST }} -p ${{ env.REDMINE_PORT }} >/dev/null 2>&1 &

            -   name: "Check if Redmine is running"
                run: curl --silent --show-error --head http://${{ env.REDMINE_HOST }}:${{ env.REDMINE_PORT }}

            # TODO: ...API Token?
            # TODO: ...environment variables for .testing?


            # ------------------------------------------------------------------------------------------------------- #
            # Run API Tests
            # ------------------------------------------------------------------------------------------------------- #

            # TODO: ...